generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String    @id @default(cuid())
  verychatId          String    @unique
  username            String?   @unique
  walletAddress       String    @unique
  email               String?   @unique
  avatarUrl           String?
  kycStatus           KYCStatus @default(NONE)
  kycMetadata         Json?
  
  // Stats
  totalTipsSent       BigInt    @default(0)
  totalTipsReceived   BigInt    @default(0)
  uniqueUsersTipped   Int       @default(0)
  tipStreak           Int       @default(0)
  lastTipAt           DateTime?
  
  // Token balances
  tokenBalances       Json      @default("{}")
  
  // Relationships
  tipsSent            Tip[]     @relation("TipsSent")
  tipsReceived        Tip[]     @relation("TipsReceived")
  badges              UserBadge[]
  leaderboardEntries  LeaderboardEntry[]
  gasSponsorship      GasSponsorship?
  aiConversations     AIConversation[]
  voiceCommands       VoiceCommand[]
  
  // Timestamps
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // Indexes
  @@index([verychatId])
  @@index([walletAddress])
  @@index([kycStatus])
}

enum KYCStatus {
  NONE
  PENDING
  VERIFIED
  REJECTED
}

model Tip {
  id              String   @id @default(cuid())
  
  // Participants
  senderId        String
  sender          User     @relation("TipsSent", fields: [senderId], references: [id])
  
  recipientId     String
  recipient       User     @relation("TipsReceived", fields: [recipientId], references: [id])
  
  // Transaction details
  tokenAddress    String
  amount          String   // Stored as string for precision
  amountInWei     BigInt
  
  // Message
  messageHash     String?
  messageEncrypted String?
  messageSentiment SentimentAnalysis?
  
  // Blockchain
  transactionHash String   @unique
  blockNumber     Int?
  tipId           Int?     // Smart contract tip ID
  
  // AI Metadata
  aiSuggestionId  String?
  aiConfidence    Float?
  aiFeatures      Json?
  
  // Status
  status          TipStatus @default(PENDING)
  errorReason     String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  confirmedAt     DateTime?
  
  // Indexes
  @@index([senderId])
  @@index([recipientId])
  @@index([transactionHash])
  @@index([createdAt])
  @@index([status])
}

enum TipStatus {
  PENDING
  CONFIRMED
  FAILED
  CANCELLED
}

model SentimentAnalysis {
  id           String   @id @default(cuid())
  tipId        String   @unique
  tip          Tip      @relation(fields: [tipId], references: [id])
  
  sentiment    String   // positive, neutral, negative
  score        Float
  categories   Json     // { toxicity: 0.1, spam: 0.05, ... }
  flags        String[] // ["hate_speech", "harassment"]
  
  // AI Metadata
  model        String
  version      String
  processedAt  DateTime @default(now())
}

model Badge {
  id              String   @id @default(cuid())
  name            String   @unique
  description     String
  imageUrl        String
  
  // Requirements
  requirements    Json     // { minTipsSent: 1, minTipsReceived: 10, ... }
  
  // Smart Contract
  contractBadgeId Int?
  onChain         Boolean  @default(false)
  
  // Community
  isCommunityFunded Boolean @default(false)
  poolBalance      String  @default("0")
  
  // Stats
  totalMinted      Int     @default(0)
  
  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relationships
  userBadges       UserBadge[]
}

model UserBadge {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  badgeId         String
  badge           Badge    @relation(fields: [badgeId], references: [id])
  
  // Blockchain
  transactionHash String?
  tokenId         String?  // NFT token ID
  
  // Metadata
  earnedAt        DateTime @default(now())
  context         Json?    // { tipId: "...", reason: "..." }
  
  // Indexes
  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@index([earnedAt])
}

model Leaderboard {
  id              String   @id @default(cuid())
  period          Period   // DAILY, WEEKLY, MONTHLY, ALL_TIME
  category        Category // TIPS_SENT, TIPS_RECEIVED, UNIQUE_TIPPERS
  
  // Rankings
  rankings        Json     // Array of { userId, score, rank, change }
  
  // Period
  periodStart     DateTime
  periodEnd       DateTime
  
  // Timestamps
  calculatedAt    DateTime @default(now())
  
  // Relationships
  entries         LeaderboardEntry[]
  
  // Indexes
  @@unique([period, category, periodStart])
  @@index([period, category])
}

model LeaderboardEntry {
  id              String   @id @default(cuid())
  leaderboardId   String
  leaderboard     Leaderboard @relation(fields: [leaderboardId], references: [id])
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  rank            Int
  score           BigInt
  change          Int      @default(0) // Change from previous period
  
  // Timestamps
  createdAt       DateTime @default(now())
  
  @@unique([leaderboardId, userId])
  @@index([userId])
  @@index([rank])
}

enum Period {
  DAILY
  WEEKLY
  MONTHLY
  ALL_TIME
}

enum Category {
  TIPS_SENT
  TIPS_RECEIVED
  UNIQUE_TIPPERS
  BADGE_COLLECTORS
  COMMUNITY_FUNDERS
}

model GasSponsorship {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  
  // Credits
  totalCredits    Int      @default(5)
  usedCredits     Int      @default(0)
  remainingCredits Int
  
  // Daily limits
  dailyUsed       Int      @default(0)
  dailyLimit      Int      @default(10)
  
  // Reset tracking
  lastResetAt     DateTime @default(now())
  nextResetAt     DateTime
  
  // Stats
  totalSponsored  BigInt   @default(0) // Total gas sponsored in wei
  
  // Timestamps
  updatedAt       DateTime @updatedAt
  
  @@index([remainingCredits])
  @@index([nextResetAt])
}

model AIConversation {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  // Context
  context         Json     // { chatId, platform, metadata }
  
  // Messages
  messages        Json     // Array of { role, content, timestamp }
  
  // AI State
  aiModel         String   @default("gpt-4")
  aiTemperature   Float    @default(0.7)
  
  // Metadata
  lastMessageAt   DateTime @default(now())
  isActive        Boolean  @default(true)
  
  // Indexes
  @@index([userId])
  @@index([lastMessageAt])
}

model VoiceCommand {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  // Audio
  audioUrl        String
  transcript      String
  confidence      Float
  
  // Command
  intent          String   // TIP, STATS, LEADERBOARD, HELP
  parameters      Json     // { recipient: "@alice", amount: 10 }
  
  // Processing
  status          CommandStatus @default(PROCESSING)
  result          Json?
  error           String?
  
  // AI Metadata
  model           String
  processingTime  Int?     // in ms
  
  // Timestamps
  createdAt       DateTime @default(now())
  processedAt     DateTime?
  
  @@index([userId])
  @@index([intent])
  @@index([createdAt])
}

enum CommandStatus {
  PROCESSING
  COMPLETED
  FAILED
}

model WebhookEvent {
  id              String   @id @default(cuid())
  
  // Source
  source          String   // VERYCHAT, BLOCKCHAIN, AI_SERVICE
  eventType       String
  payload         Json
  
  // Processing
  status          WebhookStatus @default(PENDING)
  attempts        Int      @default(0)
  lastAttemptAt   DateTime?
  error           String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  processedAt     DateTime?
  
  @@index([source])
  @@index([eventType])
  @@index([status])
  @@index([createdAt])
}

enum WebhookStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  RETRY
}
