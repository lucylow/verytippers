generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String                @id // Verychat User ID
  walletAddress      String                @unique
  publicKey          String
  tipsSent           Tip[]                 @relation("TipsSent")
  tipsReceived       Tip[]                 @relation("TipsReceived")
  content            Content[]             @relation("ContentCreator")
  subscriptions      ContentSubscription[] @relation("Subscriber")
  creatorSubscriptions ContentSubscription[] @relation("Creator")
  badges             UserBadge[]           @relation("UserBadges")
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
}

model Tip {
  id            String   @id @default(uuid())
  senderId      String
  sender        User     @relation("TipsSent", fields: [senderId], references: [id])
  recipientId   String
  recipient     User     @relation("TipsReceived", fields: [recipientId], references: [id])
  contentId     String?  // Link tip to specific content
  content       Content? @relation("ContentTips", fields: [contentId], references: [id])
  amount        String
  token         String
  message       String?
  messageHash   String?  // IPFS hash
  txHash        String?  @unique
  status        String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Badge {
  id          String     @id @default(cuid())
  badgeId     String     @unique // User-friendly badge identifier (e.g., 'first-tip')
  name        String
  emoji       String
  description String
  rarity      String     // bronze, silver, gold, platinum, diamond
  criteria    Json       // Badge criteria definition
  imageUrl    String?
  isActive    Boolean    @default(true)
  userBadges  UserBadge[] @relation("BadgeUsers")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([badgeId])
  @@index([rarity])
}

model UserBadge {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation("UserBadges", fields: [userId], references: [id])
  badgeInternalId String // References Badge.id (primary key)
  badge       Badge    @relation("BadgeUsers", fields: [badgeInternalId], references: [id])
  badgeId     String   // User-friendly badge identifier (e.g., 'first-tip') stored for easy lookup
  awardedAt   DateTime @default(now())
  revokedAt   DateTime?
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@index([badgeInternalId])
  @@index([awardedAt])
}

model Content {
  id                String            @id @default(uuid())
  creatorId         String
  creator           User              @relation("ContentCreator", fields: [creatorId], references: [id])
  title             String
  description       String?
  contentText       String?           // AI-generated text content
  contentHash       String?           // IPFS hash of content
  contentType       String            @default("TEXT") // TEXT, IMAGE, VIDEO, AUDIO, etc.
  isAI              Boolean           @default(true)
  aiModel           String?           // Which AI model generated this
  qualityScore      Float?            // AI-assessed quality score (0-1)
  monetizationType  String            @default("TIP") // TIP, SUBSCRIPTION, PAY_PER_VIEW, FREE
  price             String?           // Price for subscription/pay-per-view (in token)
  token             String?           // Token for pricing
  totalEarnings     String            @default("0") // Total earnings from this content
  totalTips         Int               @default(0) // Number of tips received
  viewCount         Int               @default(0)
  engagementScore   Float             @default(0) // Calculated engagement score
  isPublished       Boolean           @default(false)
  isPremium         Boolean           @default(false) // Premium content flag
  tips              Tip[]             @relation("ContentTips")
  analytics         ContentAnalytics[] @relation("ContentAnalytics")
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([creatorId])
  @@index([isPublished])
  @@index([qualityScore])
  @@index([totalEarnings])
}

model ContentSubscription {
  id           String   @id @default(uuid())
  subscriberId String
  subscriber   User     @relation("Subscriber", fields: [subscriberId], references: [id])
  creatorId    String
  creator      User     @relation("Creator", fields: [creatorId], references: [id])
  token        String
  amount       String   // Monthly subscription amount
  status       String   @default("ACTIVE") // ACTIVE, CANCELLED, EXPIRED
  startDate    DateTime @default(now())
  endDate      DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([subscriberId, creatorId])
  @@index([creatorId])
  @@index([subscriberId])
}

model ContentAnalytics {
  id              String   @id @default(uuid())
  contentId       String
  content         Content  @relation("ContentAnalytics", fields: [contentId], references: [id], onDelete: Cascade)
  date            DateTime @default(now())
  views           Int      @default(0)
  tips            Int      @default(0)
  earnings        String   @default("0")
  engagementScore Float    @default(0)
  createdAt       DateTime @default(now())

  @@index([contentId, date])
}
