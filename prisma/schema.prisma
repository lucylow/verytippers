generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String                @id @default(uuid())
  walletAddress      String?               @unique
  username           String?               @unique
  displayName        String?
  avatarUrl          String?
  publicKey          String?
  tipsSent           Tip[]                 @relation("Sender")
  tipsReceived       Tip[]                 @relation("Recipient")
  content            Content[]             @relation("ContentCreator")
  subscriptions      ContentSubscription[] @relation("Subscriber")
  creatorSubscriptions ContentSubscription[] @relation("Creator")
  badges             UserBadge[]           @relation("UserBadges")
  stats              UserStats?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
}

model Tip {
  id             String    @id @default(uuid())
  senderId       String
  recipientId    String
  amount         BigInt
  ipfsCid        String    @unique
  moderation     Json?
  txHash         String?   @unique
  status         TipStatus @default(PENDING)
  sender         User      @relation("Sender", fields: [senderId], references: [id])
  recipient      User      @relation("Recipient", fields: [recipientId], references: [id])
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([senderId])
  @@index([recipientId])
  @@index([status])
  @@index([createdAt])
}

enum TipStatus {
  PENDING
  PROCESSED
  FAILED
}

model Badge {
  id          String     @id @default(cuid())
  badgeId     String     @unique // User-friendly badge identifier (e.g., 'first-tip')
  name        String
  emoji       String
  description String
  rarity      String     // bronze, silver, gold, platinum, diamond
  criteria    Json       // Badge criteria definition
  imageUrl    String?
  isActive    Boolean    @default(true)
  userBadges  UserBadge[] @relation("BadgeUsers")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([badgeId])
  @@index([rarity])
}

model UserBadge {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation("UserBadges", fields: [userId], references: [id])
  badgeInternalId String // References Badge.id (primary key)
  badge       Badge    @relation("BadgeUsers", fields: [badgeInternalId], references: [id])
  badgeId     String   // User-friendly badge identifier (e.g., 'first-tip') stored for easy lookup
  awardedAt   DateTime @default(now())
  revokedAt   DateTime?
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@index([badgeInternalId])
  @@index([awardedAt])
}

model Content {
  id                String            @id @default(uuid())
  creatorId         String
  creator           User              @relation("ContentCreator", fields: [creatorId], references: [id])
  title             String
  description       String?
  contentText       String?           // AI-generated text content
  contentHash       String?           // IPFS hash of content
  contentType       String            @default("TEXT") // TEXT, IMAGE, VIDEO, AUDIO, etc.
  isAI              Boolean           @default(true)
  aiModel           String?           // Which AI model generated this
  qualityScore      Float?            // AI-assessed quality score (0-1)
  monetizationType  String            @default("TIP") // TIP, SUBSCRIPTION, PAY_PER_VIEW, FREE
  price             String?           // Price for subscription/pay-per-view (in token)
  token             String?           // Token for pricing
  totalEarnings     String            @default("0") // Total earnings from this content
  totalTips         Int               @default(0) // Number of tips received
  viewCount         Int               @default(0)
  engagementScore   Float             @default(0) // Calculated engagement score
  isPublished       Boolean           @default(false)
  isPremium         Boolean           @default(false) // Premium content flag
  tips              Tip[]             @relation("ContentTips")
  analytics         ContentAnalytics[] @relation("ContentAnalytics")
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([creatorId])
  @@index([isPublished])
  @@index([qualityScore])
  @@index([totalEarnings])
}

model ContentSubscription {
  id           String   @id @default(uuid())
  subscriberId String
  subscriber   User     @relation("Subscriber", fields: [subscriberId], references: [id])
  creatorId    String
  creator      User     @relation("Creator", fields: [creatorId], references: [id])
  token        String
  amount       String   // Monthly subscription amount
  status       String   @default("ACTIVE") // ACTIVE, CANCELLED, EXPIRED
  startDate    DateTime @default(now())
  endDate      DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([subscriberId, creatorId])
  @@index([creatorId])
  @@index([subscriberId])
}

model ContentAnalytics {
  id              String   @id @default(uuid())
  contentId       String
  content         Content  @relation("ContentAnalytics", fields: [contentId], references: [id], onDelete: Cascade)
  date            DateTime @default(now())
  views           Int      @default(0)
  tips            Int      @default(0)
  earnings        String   @default("0")
  engagementScore Float    @default(0)
  createdAt       DateTime @default(now())

  @@index([contentId, date])
}

model UserStats {
  userId       String   @id
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tipsSent     Int      @default(0)
  tipsReceived Int      @default(0)
  amountSent   BigInt   @default(0n)
  amountRecv   BigInt   @default(0n)
  rankGlobal   Int?
  rankWeekly   Int?
  updatedAt    DateTime @updatedAt

  @@index([rankGlobal])
  @@index([rankWeekly])
}
